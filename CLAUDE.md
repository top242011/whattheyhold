# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

WhatTheyHold is a financial visualization web app that helps retail investors explore ETF/Mutual Fund holdings through interactive world maps, sector breakdowns, and portfolio calculators. It supports two fund data sources: **international funds via yfinance** and **Thai funds via SEC Open Data**. It includes a **Payload CMS v3** admin panel for content management and an analytics dashboard.

## Tech Stack

### Frontend (`/frontend`)
- **Next.js 16** + **React 19** + **TypeScript 5**
- **Payload CMS v3** (integrated into Next.js as route group, PostgreSQL via Supabase)
- **Tailwind CSS 4** (custom design tokens in `globals.css`)
- **react-simple-maps** + **d3-scale** (world map), **recharts** (analytics dashboard)
- **framer-motion** (animations), **lucide-react** (icons), **sonner** (toasts)
- **clsx** + **tailwind-merge** for conditional class composition
- Path alias: `@/*` maps to `./src/*`

### Backend (`/backend`)
- **Flask 3.0** (Python) with CORS enabled
- **yfinance** (international fund data), **SEC Open Data API** (Thai fund data)
- **Supabase** (PostgreSQL via `supabase-py`)
- Virtual env at `backend/venv/`

### Database (Supabase PostgreSQL)
- App tables (public schema): `funds`, `holdings`, `country_weights`, `sector_weights`, `thai_funds`, `thai_feeder_mappings`, `analytics_sessions`, `analytics_events`
- Payload CMS tables: dedicated `payload` schema (auto-synced via `push: true` in dev)
- Schema definition: `backend/supabase_schema.sql`
- RLS policies for public read access; 24-hour cache TTL for yfinance data

## Development

### Frontend
```bash
cd frontend && npm run dev     # http://localhost:3000 (includes Payload admin at /admin)
cd frontend && npm run build   # Production build
cd frontend && npm run lint    # ESLint
```

### Backend
```bash
cd backend && source venv/bin/activate && python main.py   # http://127.0.0.1:8000
```

### Environment Variables
Frontend (`frontend/.env`):
- `DATABASE_URL` — Supabase direct Postgres connection (for Payload CMS)
- `PAYLOAD_SECRET` — 32+ char random string
- `SUPABASE_SERVICE_ROLE_KEY` — server-only key for analytics data aggregation
- `NEXT_PUBLIC_API_URL` — defaults to `http://localhost:3000`
- `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`

Backend (`backend/.env`):
- `SUPABASE_URL`, `SUPABASE_KEY` — Supabase project credentials

### API Proxy
- `next.config.ts` rewrites `/api/*` → Flask at `http://127.0.0.1:8000`
- Payload CMS REST API uses `/cms-api/*` to avoid conflict with the Flask proxy

## Key Architectural Patterns

### Route Group Architecture
The Next.js app uses two route groups with separate layouts:

- **`(site)/`** — Public-facing app (Header, Footer, AnalyticsProvider, CookieConsent)
  - `/` homepage, `/fund/[ticker]`, `/search`, `/screen`, `/compare`, `/portfolio`, `/login`, `/privacy-policy`, `/terms-of-service`
  - `/api/analytics-data` — Next.js API route for admin analytics aggregation
- **`(payload)/`** — Payload CMS admin panel (isolated layout, no site chrome)
  - `/admin` — CMS dashboard, collections, analytics view
  - `/cms-api/[...slug]` — Payload REST API

Layout isolation uses CSS `:has()` selectors: `body:has([data-payload-admin])` hides `.site-footer` and `[data-cookie-consent]`.

### Payload CMS Collections
- **AdminUsers** — Auth-enabled, 3 roles: Super Admin, Editor, Viewer
- **LegalPages** — Privacy Policy & Terms, bilingual (EN/TH), Lexical rich text
- **Complaints** — User feedback with status workflow: New → In Review → Resolved → Closed
- **FundOverrides** — Runtime per-fund overrides (hide, rename, notes)
- **SiteSettings** (global) — `heroTickers` array, `announcement` banner, `maintenanceMode` toggle

Custom admin views: Dashboard with navigation cards, Analytics dashboard with Recharts charts.

### Payload CMS Gotchas
- `withPayload` import: `@payloadcms/next/withPayload` (NOT `@payloadcms/next`)
- Turbopack alias must use relative path: `'@payload-config': './payload.config.ts'`
- Webpack alias must use absolute path: `path.resolve(process.cwd(), 'payload.config.ts')`
- Admin `[[...segments]]/page.tsx` must pass `params`/`searchParams` as Promises (not awaited) to `RootPage`
- `importMap.js` in admin dir is auto-generated by Payload

### Dual Fund Source Architecture
Two distinct fund pipelines:

**International funds (yfinance)**
- Route: `/fund/[ticker]` → `GET /api/fund/<ticker>` → `yfinance_service` → Supabase cache
- Renders `FundClientWrapper` with full holdings, country weights, sector weights

**Thai funds (SEC Open Data)**
- Route: `/fund/[proj_id]?source=sec` (optional `&feeder=<name>`)
- Non-feeder: `GET /api/thai-fund-info/<ticker>` → top 5 holdings → `ThaiFundClientWrapper`
- Feeder: `GET /api/thai-fund/<proj_id>/holdings` → master fund via yfinance → `FundClientWrapper` with feeder banner

### Frontend Data Flow
- `fund/[ticker]/page.tsx` is an **async Server Component** — fetches data server-side, passes as props to client wrappers
- `search/page.tsx` reads `?q=` from `searchParams`, passes `initialQuery` to `SearchPageClient`
- Client Components (`"use client"`) handle interactivity, local state, animations, localStorage

### API Client (`lib/api.ts`)
Uses **discriminated union types** — no thrown exceptions:
```typescript
type FundResult =
  | { status: 'ok'; data: FundResponse }
  | { status: 'not_found' }
  | { status: 'error'; message: string }
```
Always match all three cases when consuming results.

### Backend Caching (3-tier fallback for yfinance)
1. **Supabase DB** — persisted cache with 24-hour TTL (`is_cache_fresh()`)
2. **In-memory Python dict** — same-session deduplication
3. **Mock data** — fallback when both APIs fail

### Analytics Pipeline
- **Client**: `AnalyticsProvider` creates anonymous session on mount; `analytics.trackEvent()` batches events (flush every 5s or on page hide)
- **Consent**: `CookieConsent` component gates all tracking; stored in `localStorage`
- **Backend**: `POST /api/analytics/session` and `/api/analytics/event` → Supabase
- **Dashboard**: `/admin/analytics` → fetches `/api/analytics-data` (JS-side aggregation, no Supabase RPC) → Recharts visualization
- **Event types**: `page_view`, `session_start`, `search_query`, `fund_view`, `map_click`, `sector_click`, `compare_funds`

### i18n System
- **Provider**: `LocaleProvider` in `(site)/layout.tsx`
- **Hook**: `useLocale()` → `{ locale, setLocale, t: Translations }`
- **Languages**: English (`en`) and Thai (`th`)
- Use `t.someKey` for user-facing strings; `toLocaleString()` with `locale` for numbers/dates

### State Management
No Redux/Zustand. React Context for theme/locale, `useState` for component-local state, `localStorage` for persistence (read via inline script in layout to prevent flash).

## Backend API Routes

| Route | Description |
|-------|-------------|
| `GET /api/fund/<ticker>` | International fund data (yfinance) |
| `GET /api/search?q=&limit=` | Typeahead search (yfinance + Thai combined) |
| `GET /api/search/all?q=&type=&source=&limit=` | Full search page with filters |
| `GET /api/trending?limit=` | Trending funds from DB |
| `GET /api/screen?holding=&min_weight=` | Funds that hold a given ticker |
| `GET /api/thai-fund/<proj_id>` | Thai fund info by SEC proj_id |
| `GET /api/thai-fund-info/<ticker>` | Thai fund info + top 5 holdings |
| `GET /api/thai-fund/<proj_id>/holdings` | Thai feeder fund → master fund holdings |
| `GET /api/thai-funds/feeders` | List all feeder funds with master mappings |
| `POST /api/analytics/session` | Create anonymous analytics session |
| `POST /api/analytics/event` | Track analytics event |

## Design System

- **Primary**: `#47b4eb` (light blue), **Secondary**: Mint `#b2f2bb`, Lavender `#e0c3fc`
- **Dark mode**: `.dark` class on `<html>`, toggled via localStorage
- **Glass morphism**: `.glass-panel` — `backdrop-blur-2xl`, `bg-white/75`; dark: `dark:bg-slate-900/50`
- **Animations**: Framer Motion staggered entrances, animated progress bars
- Design tokens as CSS variables in `globals.css` under `@theme inline { ... }`

## Coding Conventions

### Frontend
- Functional React components; props interfaces defined inline above component
- Server Components by default; `"use client"` only when needed
- Tailwind utility classes (no CSS modules); PascalCase files organized by feature

### Backend
- Python dataclasses (`asdict()` for serialization); service layer in `services/`, routes in `main.py`
- `db_service` and `sec_db_service` as module-level singletons
- Snake_case for Python, camelCase for JSON API responses; type hints throughout

### API Response Format (yfinance funds)
```json
{
  "fund": { "ticker", "name", "price", "currency", "change_pct" },
  "holdings": [{ "ticker", "name", "pct" }],
  "country_weights": [{ "country_code", "weight_pct" }],
  "sector_weights": [{ "sector", "weight_pct" }],
  "last_updated": "ISO 8601"
}
```

## Agent Autonomy Rules

Claude Code operates with **full autonomy** on this project:

### Allowed Without Confirmation
- Read, create, edit, and delete any file in the project
- Run any shell command: install packages, start dev servers, run builds, run lints
- Create and switch git branches, make commits, push to remote
- Install npm packages and pip packages
- Modify configuration files and `.env` files (but never expose secrets in commits)
- Run database migrations and modify Supabase schema

### Decision-Making Guidelines
- Follow the existing tech stack and patterns; do not introduce new frameworks without reason
- Match the established design system (colors, spacing, glass morphism style)
- Prefer editing existing files over creating new ones
- When multiple approaches exist, pick the simplest one that works
- If a task is ambiguous, make a reasonable decision and proceed

### Safety Boundaries
- Never expose API keys, secrets, or `.env` contents in code or commits
- Never delete the `backend/.env` file
- Never push force to `main`/`master` without explicit instruction
